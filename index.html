<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Canvas test</title>
	<meta http-equiv="Content-Type" content="text/html">
	<meta name="keywords" content="" />
	<meta name="description" content="" />
	<meta name="author" content="GreenImp Web - greenimp.co.uk">

	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=IE8">

	<style>
		body{
			margin:0;
			padding:0;
			background:#C1D3EE;
		}

		canvas#testCanvas{
			display:block;;
			margin:20px auto;
			width:500px;
			height:500px;
			box-shadow:-5px 5px 5px #666;
		}
	</style>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
</head>

<body>
	<canvas width="500" height="500" id="testCanvas"></canvas>

	<script>
		Frame = function(options){
			var Frame = this,
				canvas = document.getElementById('testCanvas'),
				ctx = canvas.getContext('2d'),
				pxPermm = 1,
				frame = {		// frame information
					file:null,		// frame image file
					thickness:0,	// frame width/thickness in mm
					thicknessPx:0,	// frame width/thickness in pixels
					width:0,		// the frame width in pixels
					height:0		// the frame height in pixels
				},
				slip = {		// slip information
					file:null,		// slip image file
					thickness:0,	// slip width/thickness in mm
					thicknessPx:0	// slip width/thickness in pixels
				},
				mount = {		// mount information
					colour:'#fff',	// background colour
					border:50,		// the space between the photo and the frame in mm
					borderPx:0,		// the space between the photo and the frame in pixels
					sections:[		// mount photo sections
						[
							{
								width:0,		// image width in mm
								height:0,		// image height in mm
								widthPx:0,		// image width in pixels
								heightPx:0		// image height in pixels
							}
						]
					]
				},
				photos = [],		// list of photos for the frame
				centerPoint = {
					x:canvas.width/2,
					y:canvas.height / 2
				};

			/**
			 * Initialises the frame
			 */
			this.init = function(options){
				// set the user defined options
				options = options || {};
				$.extend(frame, options.frame || {});
				$.extend(slip, options.slip || {});
				$.extend(mount, options.mount || {});
				$.extend(photos, options.photos || []);

				// store a collection of all images
				var imageName = '',																					// temporary storage for image name
					imageCount = ((frame.file != null) ? 1 : 0) + ((slip.file != null) ? 1 : 0) + photos.length,	// count images we need to load
					loaded = 0;																						// count images that have been loaded

				// check for a frame image
				if(frame.file != null){
					//images[images.length] = frame.file;
					imageName = frame.file;
					frame.file = new Image();
					frame.file.loadCount = 0;
					frame.file.onload = function(){
						loaded++;

						if(loaded == imageCount){
							// all images have been loaded
							postLoadInit();
						}
					};
					frame.file.onerror = function(){
						if(frame.file.loadCount >= 3){
							return false;
						}

						frame.file.src = frame.file.src;
						frame.file.loadCount++;
					};
					frame.file.src = 'frames/' + imageName;
				}

				// check for a slip image
				if(slip.file != null){
					//images[images.length] = frame.file;
					imageName = slip.file;
					slip.file = new Image();
					slip.file.loadCount = 0;
					slip.file.onload = function(){
						loaded++;

						if(loaded == imageCount){
							// all images have been loaded
							postLoadInit();
						}
					};
					slip.file.onerror = function(){
						if(slip.file.loadCount >= 3){
							return false;
						}

						slip.file.src = slip.file.src;
						slip.file.loadCount++;
					};
					slip.file.src = 'frames/' + imageName;
				}

				// check for photos
				for(var i in photos){
					imageName = photos[i];
					photos[i] = new Image();
					photos[i].loadCount = 0;
					photos[i].onload = function(){
						loaded++;

						if(loaded == imageCount){
							// all images have been loaded
							postLoadInit();
						}
					};
					photos[i].onerror = function(){
						if(photos[i].loadCount >= 3){
							return false;
						}

						photos[i].src = photos[i].src;
						photos[i].loadCount++;
					};
					photos[i].src = 'frames/' + imageName;
				}

				ctx.translate(centerPoint.x, centerPoint.y);
			};

			/**
			 * Starts the actual drawing process
			 * and calculating te size of the frame
			 */
			var postLoadInit = function(){
				calculateSizes();
				Frame.draw();
			};

			/**
			 * calculate the frame sizes
			 */
			var calculateSizes = function(){
				// we need to calculate the size of the frame, in pixels, from the size in mm
				// first, calculate the total width/height in mm
				frame.thicknessPx = frame.thickness*pxPermm;
				slip.thicknessPx = slip.thickness*pxPermm;
				mount.borderPx = mount.border*pxPermm;

				frame.width = (frame.thicknessPx*2) + (slip.thicknessPx*2) + mount.borderPx;
				frame.height = (frame.thicknessPx*2) + (slip.thicknessPx*2) + mount.borderPx;

				// store the row widths
				var rowWidths = [];

				// loop through each section row
				var i = 0, j = 0;
				for(i in mount.sections){
					// define the current row
					var row = mount.sections[i];
					// start the row widths count, for this row
					rowWidths[i] = 0;

					// defines the row height
					var rowHeight = 0;

					// loop through each section in the row
					for(j in row){
						// convert the image width/heights into pixels
						row[j].widthPx = row[j].width*pxPermm;
						row[j].heightPx = row[j].height*pxPermm;

						// add the photo width to the row width
						rowWidths[i] += row[j].widthPx;
						// if the photo height is larger than the previous photo (for this row) set it as the row height
						rowHeight = (row[j].heightPx > rowHeight) ? row[j].heightPx : rowHeight;

						// if we are not on the first section of the row add some right padding
						if(j > 0){
							rowWidths[i] += mount.borderPx;
						}
						// if we are not on the first rown of the sections add some top padding
						if(i > 0){
							frame.height += mount.borderPx;
						}
					}

					// add the row height
					frame.height += rowHeight;
				}

				// ad the width of the widest row to the frame width
				frame.width += Math.max.apply(Math, rowWidths);

				// now that we have the dimensions, we need to increase/decrease them to fit as closely as possible to the canvas size
				// TODO - change pixel sizes to compensate for the canvas size
			};

			/**
			 * Handle funcion for drawing frames (rims & slips)
			 *
			 * @param x1
			 * @param y1
			 * @param x2
			 * @param y2
			 * @param thickness
			 * @param file
			 * @param fillColor
			 */
			var drawFrame = function(x1, y1, x2, y2, thickness, file, fillColor){
				if(file !== null){
					thickness = parseInt(thickness) || 0;
					var length = 0,	// tracks the current output length of a frame side
						count = 0,
						aspectRatio = file.width / file.height,
						frameHeight = Math.floor(thickness / aspectRatio);

					ctx.save();
					ctx.beginPath();
					ctx.moveTo(x1, y1);
					ctx.lineTo(x2, y1);
					ctx.lineTo(x2, y2);
					ctx.lineTo(x1, y2);
					ctx.closePath();
					ctx.clip();
					// repeat the frame down the left-hand side
					for(count = 0; length < frame.height; count++){
						ctx.drawImage(file, x1, y1 + (frameHeight*count), thickness, frameHeight);
						length += frameHeight;
					}

					// right
					var degrees = (Math.PI/180) * 180;
					ctx.rotate(degrees);
					length = 0;
					for(count = 0; length < frame.height; count++){
						ctx.drawImage(file, x1, y1 + (frameHeight*count), thickness, frameHeight);
						length += frameHeight;
					}
					ctx.rotate(-degrees);
					ctx.restore();


					ctx.save();
					ctx.beginPath();
					ctx.moveTo(x1, y1);
					ctx.lineTo(x2, y1);
					ctx.lineTo(x2-thickness, y1 + thickness);
					ctx.lineTo(x2-thickness, y2-thickness);
					ctx.lineTo(x2, y2);
					ctx.lineTo(x1, y2);
					ctx.lineTo(x1+thickness, y2-thickness);
					ctx.lineTo(x1+thickness, y1+thickness);
					ctx.closePath();
					ctx.clip();

					degrees = (Math.PI/180) * 90;
					ctx.rotate(degrees);
					// top
					length = 0;
					for(count = 0; length < frame.width; count++){
						ctx.drawImage(file, x1, y1 + (frameHeight*count), thickness, frameHeight);
						length += frameHeight;
					}
					ctx.rotate(-degrees*2);
					// bottom
					length = 0;
					for(count = 0; length < frame.width; count++){
						ctx.drawImage(file, x1, y1 + (frameHeight*count), thickness, frameHeight);
						length += frameHeight;
					}
					ctx.rotate(degrees);
					ctx.restore();
				}else{
					// frame image doesn't exist - use a colour fill
					ctx.fillStyle = fillColor || '#eaeaea';

					// top
					ctx.fillRect(x1, y1, x2-x1, thickness);
					// bottom
					ctx.fillRect(x1, y2-thickness, x2-x1, thickness);
					// left
					ctx.fillRect(x1, y1, thickness, y2-y1);
					// right
					ctx.fillRect(x2-thickness, y1, thickness, y2-y1);
				}
			};

			/**
			 * Draw the backing mount (not including
			 * any photo sections or photos)
			 */
			var drawMount = function(){
				ctx.fillStyle = mount.colour;
				ctx.fillRect(-(frame.width/2), -(frame.height/2), frame.width, frame.height);
			};

			/**
			 * Draw the actual frame rim
			 */
			var drawRim = function(){
				var frameCoords = {
					x1:-(frame.width/2),
					x2:-(frame.width/2) + frame.width,
					y1:-(frame.height/2),
					y2:-(frame.height/2)+frame.height
				};
				drawFrame(frameCoords.x1, frameCoords.y1, frameCoords.x2, frameCoords.y2, frame.thickness, frame.file);
			};

			/**
			 * Draw the frame slip
			 */
			var drawSlip = function(){
				var frameCoords = {
					x1:-(frame.width/2)+frame.thickness,
					x2:-(frame.width/2) + frame.width - frame.thickness,
					y1:-(frame.height/2) + frame.thickness,
					y2:-(frame.height/2)+frame.height - frame.thickness
				};
				drawFrame(frameCoords.x1, frameCoords.y1, frameCoords.x2, frameCoords.y2, slip.thickness, slip.file, '#ddd');
			};

			/**
			 * draw a mount picture section with the specified
			 * width and height and originating from the given
			 * center location.
			 *
			 * If image is defined, then it will also draw that.
			 *
			 * centerPoint must be an object with the x,y coordinate
			 * for the center point (relative to the frame) that the
			 * section will be drawn
			 * around.
			 * ie;
			 * {
			 *     x:20,
			 *     y:57
			 * }
			 *
			 * @param width
			 * @param height
			 * @param image
			 */
			var drawImageBlock = function(width, height, image){
				// TODO - need to calculate offset, depending on row/column
				// calculate the starting x/y coordinates
				var x1 = -(width/2),
					x2 = width/2,
					y1 = -(height/2),
					y2 = height/2;

				// fill the image section
				ctx.fillStyle = '#efefef';
				ctx.fillRect(x1, y1, x2-x1, y2-y1);

				// draw the image (if one exists)
				if(typeof image == 'object'){
					ctx.drawImage(image, x1, y1, width, height);
				}

				x1 -= 5;
				x2 += 5;
				y1 -= 5;
				y2 += 5;
				ctx.lineWidth = 1;
				ctx.strokeStyle = '#efefef';
				ctx.beginPath();
				ctx.moveTo(x1, y1);
				ctx.lineTo(x1, y2);
				ctx.lineTo(x2, y2);
				ctx.lineTo(x2, y1);
				ctx.closePath();
				ctx.stroke();

				x1--;
				x2++;
				y1--;
				y2++;
				ctx.lineWidth = 1;
				ctx.strokeStyle = '#eee';
				ctx.beginPath();
				ctx.moveTo(x1, y1);
				ctx.lineTo(x1, y2);
				ctx.lineTo(x2, y2);
				ctx.lineTo(x2, y1);
				ctx.closePath();
				ctx.stroke();
			};

			/**
			 * Draws all of the frame components;
			 * Frame, mount, slide, images etc
			 */
			this.draw = function(){
				// draw the mount
				drawMount();

				// draw the images to the mount
				var count = 0;
				for(var i in mount.sections){
					var row = mount.sections[i];
					for(var j in row){
						drawImageBlock(row[j].widthPx, row[j].heightPx, photos[count]);
					}
				}

				// draw the frame rim
				drawRim();

				// draw the frame slip
				drawSlip();
			};

			this.init(options);
		};

		new Frame({
			frame:{
				file:'frame1.jpg',
				thickness:30
			},
			slip:{
				file:'frame1.png',
				thickness:30
			},
			mount:{
				sections:[
					[
						{
							width:100,
							height:100
						},
						{
							width:100,
							height:100
						}
					],
					[
						{
							width:100,
							height:100
						}
					]
				]
			},
			photos:[
				'photo.jpg',
				'photo.jpg',
				'photo.jpg'
			]
		});
	</script>
</body>
</html>